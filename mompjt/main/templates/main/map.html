{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<div class="container main-content">
    
    <div class="map-wrapper">
        <div class="map-controls">
            <h3>ğŸ“ ìš°ë¦¬ë™ë„¤ ì°¾ê¸°</h3>
            <div class="select-group">
                <select id="sido" disabled>
                    <option>ì„œìš¸íŠ¹ë³„ì‹œ</option>
                </select>

                <select id="gugun" onchange="changeGugun()">
                    <option value="">ëª¨ë“  êµ¬</option>
                    <option value="gangnam">ê°•ë‚¨êµ¬</option>
                    <option value="seocho">ì„œì´ˆêµ¬</option>
                    <option value="songpa">ì†¡íŒŒêµ¬</option>
                    <option value="mapo">ë§ˆí¬êµ¬</option>
                </select>

                <select id="dong" onchange="moveMapToDong()">
                    <option value="">ëª¨ë“  ë™</option>
                </select>
            </div>
        </div>

        <div class="category-btn-group">
            <button onclick="findPlaces('hospital')">ğŸ¥ ë³‘ì›</button>
            <button onclick="findPlaces('pharmacy')">ğŸ’Š ì•½êµ­</button>
            <button onclick="findPlaces('cafe')">â˜• ì¹´í˜/ë§›ì§‘</button>
            <button onclick="findPlaces('store')">ğŸª í¸ì˜ì </button>
        </div>

        <div id="map"></div>
    </div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    /* ---------------------------------------------------------
       1. ì§€ë„ ìƒì„± ë° ì„¤ì •
       --------------------------------------------------------- */
    // ê¸°ë³¸ ì¤Œ ì»¨íŠ¸ë¡¤(ì™¼ìª½ ìƒë‹¨) ë„ê³  ìƒì„±
    var map = L.map('map', {
        zoomControl: false 
    }).setView([37.5665, 126.9780], 11); // ì´ˆê¸°ìœ„ì¹˜: ì„œìš¸ ì‹œì²­

    // ì¤Œ ì»¨íŠ¸ë¡¤ì„ 'ì˜¤ë¥¸ìª½ ìƒë‹¨'ì— ìƒˆë¡œ ì¶”ê°€
    L.control.zoom({
        position: 'topright'
    }).addTo(map);

    // êµ¬ê¸€ ì§€ë„ (í•œê¸€íŒ) ë°°ê²½ ì„¤ì •
    L.tileLayer('http://mt0.google.com/vt/lyrs=m&hl=ko&x={x}&y={y}&z={z}', {
        attribution: '&copy; Google Maps',
        maxZoom: 20
    }).addTo(map);


    /* ---------------------------------------------------------
       2. ì§€ì—­ ë°ì´í„° (êµ¬/ë™ ì •ë³´)
       --------------------------------------------------------- */
    const areaData = {
        "gangnam": {
            center: [37.5172, 127.0473],
            dongs: {
                "sinsa": { name: "ì‹ ì‚¬ë™", coords: [37.5240, 127.0227] },
                "apgujeong": { name: "ì••êµ¬ì •ë™", coords: [37.5273, 127.0284] },
                "nonhyeon": { name: "ë…¼í˜„ë™", coords: [37.5113, 127.0283] },
                "yeoksam": { name: "ì—­ì‚¼ë™", coords: [37.5007, 127.0365] }
            }
        },
        "seocho": {
            center: [37.4837, 127.0324],
            dongs: {
                "seocho": { name: "ì„œì´ˆë™", coords: [37.4878, 127.0175] },
                "banpo": { name: "ë°˜í¬ë™", coords: [37.5024, 126.9961] },
                "bangbae": { name: "ë°©ë°°ë™", coords: [37.4827, 126.9926] }
            }
        },
        "mapo": {
            center: [37.5663, 126.9016],
            dongs: {
                "hongdae": { name: "ì„œêµë™", coords: [37.5547, 126.9224] },
                "sangam": { name: "ìƒì•”ë™", coords: [37.5791, 126.8893] },
                "mangwon": { name: "ë§ì›ë™", coords: [37.5562, 126.9013] }
            }
        },
        "songpa": {
             center: [37.5145, 127.1066],
             dongs: {
                 "jamsil": { name: "ì ì‹¤ë™", coords: [37.5133, 127.0827] },
                 "munjeong": { name: "ë¬¸ì •ë™", coords: [37.4849, 127.1235] }
             }
        }
    };


    /* ---------------------------------------------------------
       3. ê¸°ëŠ¥ í•¨ìˆ˜ë“¤
       --------------------------------------------------------- */

    // [êµ¬ ë³€ê²½] ì‹œ ì§€ë„ ì´ë™ & ë™ ëª©ë¡ ê°±ì‹ 
    function changeGugun() {
        var guSelect = document.getElementById("gugun");
        var dongSelect = document.getElementById("dong");
        var selectedGu = guSelect.value;

        dongSelect.innerHTML = '<option value="">ëª¨ë“  ë™</option>';

        if (selectedGu && areaData[selectedGu]) {
            map.flyTo(areaData[selectedGu].center, 13, { duration: 1.5 });
            var dongs = areaData[selectedGu].dongs;
            for (var key in dongs) {
                var option = document.createElement("option");
                option.value = key;
                option.text = dongs[key].name;
                option.setAttribute('data-lat', dongs[key].coords[0]);
                option.setAttribute('data-lng', dongs[key].coords[1]);
                dongSelect.appendChild(option);
            }
        } else {
            map.flyTo([37.5665, 126.9780], 11);
        }
    }

    // [ë™ ë³€ê²½] ì‹œ ì§€ë„ ì´ë™ & ë§ˆì»¤ í‘œì‹œ
    function moveMapToDong() {
        var dongSelect = document.getElementById("dong");
        var selectedOption = dongSelect.options[dongSelect.selectedIndex];

        if (selectedOption.value !== "") {
            var lat = selectedOption.getAttribute('data-lat');
            var lng = selectedOption.getAttribute('data-lng');
            map.flyTo([lat, lng], 15, { duration: 1.5 });
            L.marker([lat, lng]).addTo(map)
                .bindPopup("<b>" + selectedOption.text + "</b><br>ë§˜ìŠ¤ë¡œê·¸ ìš°ë¦¬ë™ë„¤!")
                .openPopup();
        }
    }

    // [ì¥ì†Œ ì°¾ê¸°] (ì²´í—˜íŒ ê¸°ëŠ¥: ëœë¤ ë§ˆì»¤)
    var markers = [];

// [ì¥ì†Œ ì°¾ê¸°] ê¸°ëŠ¥ ìˆ˜ì •: í´ë¦­ ì‹œ ì§€ë„ í™•ëŒ€(Zoom In) ì¶”ê°€
    function findPlaces(category) {
        // 1. ê¸°ì¡´ì— ì°í˜€ìˆë˜ ë§ˆì»¤ë“¤ ì‹¹ ì§€ìš°ê¸°
        for(var i=0; i < markers.length; i++){
            map.removeLayer(markers[i]);
        }
        markers = []; // ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°

        // 2. í˜„ì¬ ì§€ë„ì˜ ì¤‘ì‹¬ ì¢Œí‘œ ê°€ì ¸ì˜¤ê¸°
        var center = map.getCenter();
        
        // â˜… [í•µì‹¬ ì¶”ê°€] ì§€ë„ë¥¼ 16ë ˆë²¨ë¡œ ë¶€ë“œëŸ½ê²Œ í™•ëŒ€! (ìˆ«ìê°€ í´ìˆ˜ë¡ ë” ë§ì´ í™•ëŒ€ë¨)
        map.flyTo(center, 16, { duration: 1.5 });

        // 3. ì¹´í…Œê³ ë¦¬ë³„ ì´ë¦„í‘œ ì„¤ì •
        var label = "";
        if(category === 'hospital') { label = "ì†Œì•„ê³¼"; }
        else if(category === 'pharmacy') { label = "ì•½êµ­"; }
        else if(category === 'cafe') { label = "ì¹´í˜"; }
        else { label = "í¸ì˜ì "; }

        // 4. ì§€ë„ ì¤‘ì‹¬ ì£¼ë³€ì— ëœë¤ ë§ˆì»¤ ì°ê¸° (ì²´í—˜íŒ)
        // ì¤Œì¸ì´ ë˜ë‹ˆê¹Œ ë§ˆì»¤ë“¤ì„ ì¤‘ì‹¬ì— ì¢€ ë” ëª¨ì•„ì„œ ì°ì–´ì¤ë‹ˆë‹¤ (* 0.005)
        for (var i = 0; i < 5; i++) {
            var lat = center.lat + (Math.random() - 0.5) * 0.005; 
            var lng = center.lng + (Math.random() - 0.5) * 0.005;
            
            var marker = L.marker([lat, lng]).addTo(map)
                .bindPopup("<b> " + label + " " + (i+1) + "í˜¸ì </b><br>ê±°ë¦¬: ì•„ì£¼ ê°€ê¹Œì›€")
                .openPopup(); // ë§ˆì»¤ ì°ìë§ˆì ë§í’ì„  ì—´ê¸°
            
            markers.push(marker);
        }
    }
</script>
{% endblock %}